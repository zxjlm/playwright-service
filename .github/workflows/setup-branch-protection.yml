name: Setup Branch Protection

on:
  workflow_dispatch:
  repository_dispatch:
    types: [setup-protection]

jobs:
  setup-branch-protection:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      administration: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Branch Protection for main
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const branch = 'main';
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            try {
              await github.rest.repos.updateBranchProtection({
                owner: owner,
                repo: repo,
                branch: branch,
                required_status_checks: null,
                enforce_admins: false,
                required_pull_request_reviews: {
                  required_approving_review_count: 1,
                  dismiss_stale_reviews: true,
                  require_code_owner_reviews: false,
                  require_last_push_approval: false
                },
                restrictions: null,
                required_linear_history: false,
                allow_force_pushes: false,
                allow_deletions: false,
                block_creations: false,
                required_conversation_resolution: true,
                lock_branch: false,
                allow_fork_syncing: false
              });
              
              console.log(`âœ… æˆåŠŸä¸º ${branch} åˆ†æ”¯è®¾ç½®äº†ä¿æŠ¤è§„åˆ™`);
              console.log('ğŸ“‹ ä¿æŠ¤è§„åˆ™åŒ…æ‹¬:');
              console.log('   - å¿…é¡»é€šè¿‡ Pull Request åˆå¹¶');
              console.log('   - éœ€è¦è‡³å°‘ 1 ä¸ªä»£ç å®¡æŸ¥æ‰¹å‡†');
              console.log('   - ç¦æ­¢å¼ºåˆ¶æ¨é€');
              console.log('   - ç¦æ­¢åˆ é™¤åˆ†æ”¯');
              console.log('   - éœ€è¦è§£å†³æ‰€æœ‰å¯¹è¯');
            } catch (error) {
              if (error.status === 404) {
                console.error(`âŒ é”™è¯¯: ä»“åº“ ${owner}/${repo} ä¸å­˜åœ¨æˆ–æ²¡æœ‰è®¿é—®æƒé™`);
              } else if (error.status === 403) {
                console.error(`âŒ é”™è¯¯: æ²¡æœ‰è¶³å¤Ÿçš„æƒé™è®¾ç½®åˆ†æ”¯ä¿æŠ¤è§„åˆ™ã€‚éœ€è¦ 'administration' æƒé™ã€‚`);
              } else {
                console.error(`âŒ é”™è¯¯: ${error.message}`);
              }
              throw error;
            }
